{% extends "layout.njk" %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/panel/macro.njk" import govukPanel %}
{% from "components/contactMethodText.njk" import contactMethodText %}

{% set pageHeaderTitle = "Visit updated" if isUpdate else "Visit confirmed" %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      {{ govukPanel({
        titleText: pageHeaderTitle,
        html: 'The booking reference is<br><strong class="test-booking-reference">' + visitReference + "</strong>"
      }) }}
    </div>
  </div>

  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      {% include "partials/errorSummary.njk" %}

      {% if isUpdate %}
        <h2 class="govuk-heading-m govuk-!-margin-top-6">What happens next</h2>
        <p>The visit has been updated.</p>
        {% if hasEmailAddress or hasMobileNumber %}
          <p data-test="contact-method-text">The main contact will get {{ contactMethodText(hasEmailAddress, hasMobileNumber) }} to confirm the updated booking. This will include the booking reference.</p>
        {% endif %}
      {% else %}
        <h2 class="govuk-heading-m govuk-!-margin-top-6">What to do next</h2>
        <p>Let the booker know:</p>
        <ul class="govuk-body">
          {% if hasEmailAddress or hasMobileNumber %}
            <li data-test="contact-method-text">{{ contactMethodText(hasEmailAddress, hasMobileNumber) }} with the booking reference will be sent to the main contact</li>
          {% endif %}
          <li>the booking reference is needed to <a href="/search/visit">cancel or update the booking</a></li>
          <li>
            changes can be made up to 
            <span data-test="booking-changes-days">{{ selectedEstablishment.policyNoticeDaysMin }} {{ "day" | pluralise(selectedEstablishment.policyNoticeDaysMin) }}</span>
            before the visit
          </li>
        </ul>
        <p>To prepare for the visit day, tell the booker:</p>
        <ul class="govuk-body">
          <li>what time to arrive for the visit</li>
          <li>
            all visitors 16 years old or older will need to bring
            <a class="govuk-link--no-visited-state" href="https://www.gov.uk/government/publications/management-of-security-at-visits-policy-framework-open-estate/acceptable-forms-of-identification-id-when-visiting-a-prison-in-england-and-wales-annex-a">acceptable forms of ID</a>
          </li>
          <li>any prison specific rules (such as clothing guidelines)</li>
          <li>
            they can find more information on
            <a data-test="prison-website" href="{{ selectedEstablishment.webAddress }}">{{ selectedEstablishment.prisonName }}’s GOV.UK page</a>
          </li>
          <li>some people can <a class="govuk-link--no-visited-state" href="https://www.gov.uk/help-with-prison-visits">get help with the cost of visits</a></li>
        </ul>
      {% endif %}
      <div>
        {{ govukButton({
          classes: "govuk-!-margin-top-3 govuk-!-margin-bottom-4",
          text: "Go to manage prison visits",
          attributes: { "data-test": "go-to-home" },
          href: "/",
          preventDoubleClick: true
        }) }}
      </div>
      <div>
        {{ govukButton({
          classes: "govuk-!-margin-bottom-6 govuk-button--secondary",
          text: "View this prisoner’s profile",
          attributes: { "data-test": "go-to-prisoner" },
          href: "/prisoner/" + prisoner.offenderNo,
          preventDoubleClick: true
        }) }}
      </div>
    </div>
  </div>

  {% set displayRows = [
    {
      key: {
        text: "Prisoner name"
      },
      value: {
        text: prisoner.firstName + ' ' + prisoner.lastName,
        classes: "test-visit-prisoner-name"
      }
    },
    {
      key: {
        text: "Prison number"
      },
      value: {
        text: prisoner.offenderNo,
        classes: "test-visit-prisoner-number"
      }
    },
    {
      key: {
        text: "Establishment"
      },
      value: {
        text: selectedEstablishment.prisonName,
        classes: "test-visit-prison"
      }
    },
    {
      key: {
        text: "Date"
      },
      value: {
        text: visitSession.date | formatDate("EEEE d MMMM yyyy"),
        classes: "test-visit-date"
      }
    },
    {
      key: {
        text: "Time"
      },
      value: {
        text: visitSession | formatStartToEndTime,
        classes: "test-visit-time"
      }
    },
    {
      key: {
        text: "Visit type"
      },
      value: {
        text: visitRestriction | capitalize,
        classes: "test-visit-type"
      }
    }
  ] %}

  {%- for visitor in visitors %}
    {% set displayRows = (displayRows.push(
      {
        key: {
          text: "Visitor " + loop.index
        },
        value: {
          html: '<p><span class="test-visitor-name' + loop.index + '">' + visitor.name | escape + " (" + (visitor.relationshipDescription | lower) + ' of the prisoner)</span><br><span class="test-visitor-address' + loop.index + '">' + visitor.address | escape | replace("\n", " ") + "</span>"
        }
      }
    ), displayRows) %}
  {% endfor %}
  {% set support %}
    {% if additionalSupport | length %}
      {{ additionalSupport }}
    {% else %}
      {{ "None." }}
    {% endif %}
  {% endset %}
  {% set displayRows = (displayRows.push(
    {
      key: {
        text: "Additional support requests"
      },
      value: {
        html: '<p class="test-additional-support">' + support | escape + '</p>'
      }
    }
  ), displayRows) %}

  {% set contactName -%}
    {{- mainContact.contactName }}
    {%- if mainContact.relationshipDescription %} ({{ mainContact.relationshipDescription | lower}} of the prisoner){% endif %}
  {%- endset %}

  {% set displayRows = (displayRows.push(
    {
      key: {
        text: "Main contact"
      },
      value: {
        html: '<p class="test-main-contact-name">' + contactName + '</p><p class="test-main-contact-number">' +
          mainContact.phoneNumber | d("No phone number provided", true) | escape + '</p><p class="test-main-contact-email">' + mainContact.email | escape + '</p>'
      }
    }
  ), displayRows) %}
     
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <h2 class="govuk-heading-m">Visit details</h2>
      {{ govukSummaryList ({
        rows: displayRows
      })}}
    </div>
  </div>
{% endblock %}
