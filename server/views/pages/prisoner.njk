{% extends "../partials/layout.njk" %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/breadcrumbs/macro.njk" import govukBreadcrumbs %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{%- from "govuk/components/tag/macro.njk" import govukTag -%}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}

{% set pageHeaderTitle = displayName %}
{% set pageTitle = applicationName + " - " + pageHeaderTitle %}
{% set backLinkHref = "/search" %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      <h1 class="govuk-heading-l">{{ pageHeaderTitle }}</h1>

      {% if flaggedAlerts.length %}
      <ul class="flagged-alerts-list">
        {% for alert in flaggedAlerts %}
        <li>
          {{ govukTag({
            text: alert.alertCodeDescription,
            classes: "flagged-alert flagged-alert--" + alert.alertCode
          }) }}
        </li>
        {% endfor %}
      </ul>
      {% endif %}

      <ul class="prisoner-profile-summary">
        <li>
          <strong>Prison number</strong>
          {{ inmateDetail.offenderNo }}
        </li>
        <li>
          <strong>Date of birth</strong>
          {{ displayDob }}
        </li>
        <li>
          <strong>Location</strong>
          {{ inmateDetail.assignedLivingUnit.description + ", " + inmateDetail.assignedLivingUnit.agencyName if inmateDetail.assignedLivingUnit}}
        </li>
        <li>
          <strong>Category</strong>
          {{ inmateDetail.category }}
        </li>
        <li>
          <strong>Incentive level</strong>
          {{ inmateDetail.privilegeSummary.iepLevel }}
        </li>
        <li>
          <strong>Conviction status</strong>
          {{ convictedStatus }}
        </li>
        <li>
          <strong>Alerts</strong>
          <span>{{ inmateDetail.activeAlertCount }} active</span>
        </li>
        {% if visitBalances %}
        <li>
          <strong>Visiting orders</strong>
          <span>Remaining VOs: {{ visitBalances.remainingVo }}</span>
          <span>Remaining PVOs: {{ visitBalances.remainingPvo }}</span>
        </li>
        {% endif %}
      </ul>

      {{ govukButton({
        text: "Book a prison visit",
        href: "/select-visitors/" + inmateDetail.offenderNo
      }) }}

    </div>
  </div>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
    {% set visitingOrdersTab %}
    <h2 class="govuk-heading-m">Visiting orders</h2>
    {{ govukTable({
      head: [
        {
          text: "Type"
        },
        {
          text: "Balance"
        },
        {
          text: "Last allocation date"
        },
        {
          text: "Next allocation date"
        }
      ],
      rows: [
        [
          {
            html: "<strong>VO</strong>"
          },
          {
            text: visitBalances.remainingVo
          },
          {
            text: visitBalances.latestIepAdjustDate
          },
          {
            text: visitBalances.nextIepAdjustDate
          }
        ],
        [
          {
            html: "<strong>PVO</strong>"
          },
          {
            text: visitBalances.remainingPvo
          },
          {
            text: visitBalances.latestPrivIepAdjustDate
          },
          {
            text: visitBalances.nextPrivIepAdjustDate
          }
        ]
      ]
    }) }}
    {% endset %}
    {% set alertsTab %}
    <h2 class="govuk-heading-m">Active alerts</h2>
    {% if activeAlerts | length %}
      {{ govukTable({
        head: [
          {
            text: "Type of alert",
            classes: "bapv-table_cell--nowrap"
          },
          {
            text: "Alert"
          },
          {
            text: "Comments"
          },
          {
            text: "Date from",
            classes: "bapv-table_cell--nowrap"
          },
          {
            text: "Date to",
            classes: "bapv-table_cell--nowrap"
          }
        ],
        rows: activeAlerts
      }) }}
    {% else %}
    <p>There are no active alerts for this prisoner.</p>
    {% endif %}
    {% endset %}
    {% set upcomingVisitsTab %}
    <h2 class="govuk-heading-m">Upcoming visits</h2>
    {% if upcomingVisits | length %}
      {{ govukTable({
        head: [
          {
            text: "Visit type"
          },
          {
            text: "Location"
          },
          {
            text: "Date and time"
          },
          {
            text: "Visitors"
          }
        ],
        rows: upcomingVisits
      }) }}
    {% else %}
    <p>There are no upcoming visits for this prisoner.</p>
    {% endif %}
    {% endset %}
    {% set pastVisitsTab %}
    <h2 class="govuk-heading-m">Visits history</h2>
    {% if pastVisits | length %}
      {{ govukTable({
        head: [
          {
            text: "Visit type"
          },
          {
            text: "Location"
          },
          {
            text: "Date and time"
          },
          {
            text: "Visitors"
          },
          {
            text: "Visit status"
          }
        ],
        rows: pastVisits
      }) }}
    {% else %}
    <p>There no visit history for this prisoner.</p>
    {% endif %}
    {% endset %}
    {{ govukTabs({
      items: [
        {
          label: "Visiting orders",
          id: "visiting-orders",
          panel: {
            html: visitingOrdersTab
          }
        } if visitBalances,
        {
          label: "Active alerts",
          id: "active-alerts",
          panel: {
            html: alertsTab
          }
        },
        {
          label: "Upcoming visits",
          id: "upcoming-visits",
          panel: {
            html: upcomingVisitsTab
          }
        },
        {
          label: "Visits history",
          id: "visits-history",
          panel: {
            html: pastVisitsTab
          }
        }
      ]
    }) }}
    </div>
  </div>
{% endblock %}
