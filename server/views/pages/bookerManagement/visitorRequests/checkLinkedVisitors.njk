{% extends "layout.njk" %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/table/macro.njk" import govukTable %}

{% set pageHeaderTitle = "Check if the visitor is already linked" %}
{% set backLinkHref = "/manage-bookers/visitor-request/" + visitorRequest.reference + "/link-visitor" %}

{% set linkedVisitorRows = [] %}
{% for visitor in linkedVisitors %}
  {% set linkedVisitorRows = (linkedVisitorRows.push([
    {
      text: visitor.firstName + " " + visitor.lastName,
      classes: "govuk-!-font-weight-bold",
      attributes: { "data-test": "visitor-" + loop.index + "-name" }
    },
    {
      text: (visitor.dateOfBirth | formatDate +
        " (" + visitor.dateOfBirth | displayAge + ")") if visitor.dateOfBirth
        else "Not entered",
      attributes: { "data-test": "visitor-" + loop.index + "-dob" }
    }
  ]), linkedVisitorRows)%}
{% endfor %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

      {% include "partials/errorSummary.njk" %}

      <h1 class="govuk-heading-xl">{{ pageHeaderTitle }}</h1>

      <p class="govuk-body-l">
        <span data-test="booker-email">{{ visitorRequest.bookerEmail }}</span> has requested to link:
      </p>
      <p class="govuk-body-l">
        <span data-test="visitor-name" class="govuk-!-font-weight-bold">{{ visitorRequest.firstName }} {{ visitorRequest.lastName }}</span>,
        born on
        <span data-test="visitor-dob" class="govuk-!-font-weight-bold">{{ visitorRequest.dateOfBirth | formatDate }}</span>
      </p>

      <h2 class="govuk-heading-l">Linked visitors</h2>
      <p>
        These visitors for
        <span data-test="prisoner-name">{{ (visitorRequest.prisonerFirstName + " " + visitorRequest.prisonerLastName) | properCaseFullName }}</span>
        are already linked to the bookerâ€™s account. 
      </p>

      {% if linkedVisitorRows | length %}
        {{ govukTable({
          classes: "govuk-!-width-one-half govuk-!-margin-bottom-8",
          head: [
            {
              text: "Name"
            },
            {
              text: "Date of birth"
            }
          ],
          rows: linkedVisitorRows
        }) }}
      {% endif %}

      <form action="/manage-bookers/visitor-request/{{ visitorRequest.reference }}/check-linked-visitors" method="POST" novalidate>
        <input type="hidden" name="_csrf" value="{{ csrfToken }}">

        {{ govukRadios({
          name: "rejectReason",
          fieldset: {
            legend: {
              text: "Is the visitor already linked?",
              classes: "govuk-fieldset__legend--l"
            }
          },
          items: [
            {
              value: "ALREADY_LINKED",
              text: "Yes, tell the booker that the visitor is already linked to their account"
            },
            {
              value: "REJECT",
              text: "No, reject the request"
            }
          ],
          errorMessage: errors | findError('rejectReason')
        }) }}

        {{ govukButton({
          text: "Confirm",
          attributes: { "data-test": "reject-request" },
          classes: "govuk-!-margin-top-3",
          preventDoubleClick: true
        }) }}

      </form>
    </div>
  </div>
{% endblock %}
